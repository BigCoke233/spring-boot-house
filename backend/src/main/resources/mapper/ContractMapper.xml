<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zgqf.house.mapper.ContractMapper">

    <!-- 合同详情映射（包含买方和房源信息） -->
    <resultMap id="ContractDetailMap" type="com.zgqf.house.entity.Contract">
        <id column="c_id" property="id"/>
        <result column="c_buyer_id" property="buyerId"/>
        <result column="c_house_id" property="houseId"/>
        <result column="c_total_price" property="totalPrice"/>
        <result column="c_pay_way" property="payWay"/>
        <result column="c_paytime_ending" property="paytimeEnding"/>
        <result column="c_paytime_actually" property="paytimeActually"/>
        <result column="c_delivery_ending" property="deliveryEnding"/>
        <result column="c_delivery_actually" property="deliveryActually"/>
        <result column="c_buyer_agree" property="buyerAgree"/>
        <result column="c_seller_agree" property="sellerAgree"/>
        <result column="c_paid" property="paid"/>
        <result column="c_delivered" property="delivered"/>
        <result column="h_seller_id" property="sellerId"/>
        <result column="i_down_payment" property="downPayment"/>
        <result column="i_total_periods" property="totalPeriods"/>
        <result column="i_paid_count" property="paidCount"/>

        <!-- 关联买方信息 -->
        <association property="buyer" javaType="com.zgqf.house.entity.Buyer">
            <id column="b_id" property="id"/>
            <result column="b_name" property="name"/>
            <result column="b_phone" property="phone"/>
            <result column="b_email" property="email"/>
        </association>

        <!-- 关联房源信息 -->
        <association property="house" javaType="com.zgqf.house.entity.House">
            <id column="h_id" property="id"/>
            <result column="h_name" property="name"/>
            <result column="h_price" property="price"/>
            <result column="h_square" property="square"/>
        </association>
    </resultMap>

    <!-- === 新增方法实现 === -->

    <!-- 查询合同列表 -->
    <select id="selectContractList" resultMap="ContractDetailMap">
        SELECT c.*, b.*, h.*, i.i_down_payment, i.i_total_periods, i.i_paid_count
        FROM contract c
        LEFT JOIN buyer b ON c.c_buyer_id = b.b_id
        LEFT JOIN house h ON c.c_house_id = h.h_id
        LEFT JOIN installment i ON c.c_id = i.i_contract_id
        WHERE 1=1
        <if test="buyerId != null">
            AND c.c_buyer_id = #{buyerId}
        </if>
        <if test="sellerId != null">
            AND h.h_seller_id = #{sellerId}
        </if>
        <if test="houseId != null">
            AND c.c_house_id = #{houseId}
        </if>
        <if test="buyerAgree != null">
            AND c.c_buyer_agree = #{buyerAgree}
        </if>
        <if test="sellerAgree != null">
            AND c.c_seller_agree = #{sellerAgree}
        </if>
        <if test="paid != null">
            AND c.c_paid = #{paid}
        </if>
        <if test="delivered != null">
            AND c.c_delivered = #{delivered}
        </if>
        <if test="startDate != null">
            AND c.c_paytime_ending >= #{startDate}
        </if>
        <if test="endDate != null">
            AND c.c_paytime_ending &lt;= #{endDate}
        </if>
        ORDER BY ${sortBy} ${sortOrder}
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- 统计合同数量 -->
    <select id="countContractList" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM contract c
        LEFT JOIN house h ON c.c_house_id = h.h_id
        WHERE 1=1
        <if test="buyerId != null">
            AND c.c_buyer_id = #{buyerId}
        </if>
        <if test="sellerId != null">
            AND h.h_seller_id = #{sellerId}
        </if>
        <if test="houseId != null">
            AND c.c_house_id = #{houseId}
        </if>
        <if test="buyerAgree != null">
            AND c.c_buyer_agree = #{buyerAgree}
        </if>
        <if test="sellerAgree != null">
            AND c.c_seller_agree = #{sellerAgree}
        </if>
        <if test="paid != null">
            AND c.c_paid = #{paid}
        </if>
        <if test="delivered != null">
            AND c.c_delivered = #{delivered}
        </if>
        <if test="startDate != null">
            AND DATE(c.c_paytime_ending) >= DATE(#{startDate})
        </if>
        <if test="endDate != null">
            AND DATE(c.c_paytime_ending) &lt;= DATE(#{endDate})
        </if>
    </select>

    <!-- 查询合同详情 -->
    <select id="selectContractDetailById" resultMap="ContractDetailMap">
        SELECT c.*, b.*, h.*, i.i_down_payment, i.i_total_periods, i.i_paid_count
        FROM contract c
                 LEFT JOIN buyer b ON c.c_buyer_id = b.b_id
                 LEFT JOIN house h ON c.c_house_id = h.h_id
                 LEFT JOIN installment i ON c.c_id = i.i_contract_id
        WHERE c.c_id = #{id}
    </select>

    <!-- 插入合同 -->
    <insert id="insertContract" useGeneratedKeys="true" keyProperty="c_id">
        INSERT INTO contract(
            c_buyer_id, c_house_id, c_total_price, c_pay_way,
            c_paytime_ending, c_delivery_ending,
            c_buyer_agree, c_seller_agree, c_paid, c_delivered
        ) VALUES(
                    #{buyerId}, #{houseId}, #{totalPrice}, #{payWay},
                    #{paytimeEnding}, #{deliveryEnding},
                    0, 0, 0, 0
                )
    </insert>

    <!-- 更新合同 -->
    <update id="updateContract">
        UPDATE contract
        <set>
            <if test="buyerAgree != null">c_buyer_agree = #{buyerAgree},</if>
            <if test="sellerAgree != null">c_seller_agree = #{sellerAgree},</if>
            <if test="paytimeActually != null">c_paytime_actually = #{paytimeActually},</if>
            <if test="deliveryActually != null">c_delivery_actually = #{deliveryActually},</if>
            <if test="paid != null">c_paid = #{paid},</if>
            <if test="delivered != null">c_delivered = #{delivered}</if>
        </set>
        WHERE c_id = #{id}
    </update>

    <!-- 删除合同 -->
    <delete id="deleteContract">
        DELETE FROM contract WHERE c_id = #{id}
    </delete>

    <!-- 更新买方同意状态 -->
    <update id="updateBuyerAgree">
        UPDATE contract SET c_buyer_agree = #{agree} WHERE c_id = #{id}
    </update>

    <!-- 更新卖方同意状态 -->
    <update id="updateSellerAgree">
        UPDATE contract SET c_seller_agree = #{agree} WHERE c_id = #{id}
    </update>

    <!-- 更新付款状态 -->
    <update id="updatePaymentStatus">
        UPDATE contract SET c_paid = #{paid} WHERE c_id = #{id}
    </update>

    <!-- 更新交房状态 -->
    <update id="updateDeliveryStatus">
        UPDATE contract SET c_delivered = #{delivered} WHERE c_id = #{id}
    </update>

    <!-- 统计买家合同数量 -->
    <select id="countContractByBuyerId" resultType="java.lang.Long">
        SELECT COUNT(*) FROM contract WHERE c_buyer_id = #{buyerId}
    </select>

    <!-- 统计卖家合同数量 -->
    <select id="countContractBySellerId" resultType="java.lang.Long">
        SELECT COUNT(*) 
        FROM contract c 
        LEFT JOIN house h ON c.c_house_id = h.h_id 
        WHERE h.h_seller_id = #{sellerId}
    </select>

    <!-- === 原始方法实现 (兼容旧接口) === -->

    <select id="getContractsBySeller" resultMap="ContractDetailMap">
        SELECT c.*, b.*, h.*
        FROM contract c
        LEFT JOIN buyer b ON c.c_buyer_id = b.b_id
        LEFT JOIN house h ON c.c_house_id = h.h_id
        WHERE h.h_seller_id = #{s_id}
    </select>

    <select id="getContractsByBuyer" resultMap="ContractDetailMap">
        SELECT c.*, b.*, h.*
        FROM contract c
        LEFT JOIN buyer b ON c.c_buyer_id = b.b_id
        LEFT JOIN house h ON c.c_house_id = h.h_id
        WHERE c.c_buyer_id = #{b_id}
    </select>

    <select id="getContractsById" resultMap="ContractDetailMap">
        SELECT c.*, b.*, h.*
        FROM contract c
        LEFT JOIN buyer b ON c.c_buyer_id = b.b_id
        LEFT JOIN house h ON c.c_house_id = h.h_id
        WHERE c.c_id = #{c_id}
    </select>

    <select id="getSellerByContract" resultType="com.zgqf.house.entity.Seller">
        SELECT s.* 
        FROM seller s 
        JOIN house h ON s.s_id = h.h_seller_id 
        JOIN contract c ON h.h_id = c.c_house_id 
        WHERE c.c_id = #{c_id}
    </select>

    <select id="getBuyerByContract" resultType="com.zgqf.house.entity.Buyer">
        SELECT b.* 
        FROM buyer b 
        JOIN contract c ON b.b_id = c.c_buyer_id 
        WHERE c.c_id = #{c_id}
    </select>

    <update id="signContract">
        UPDATE contract
        <set>
            <if test="buyerAgree != null">c_buyer_agree = #{buyerAgree},</if>
            <if test="sellerAgree != null">c_seller_agree = #{sellerAgree},</if>
        </set>
        WHERE c_id = #{id}
    </update>

    <select id="houseUsable" resultMap="ContractDetailMap">
        SELECT * FROM contract 
        WHERE c_house_id = #{h_id} 
        AND c_buyer_agree != -1 
        AND c_seller_agree != -1
    </select>

    <select id="getLastInsertContract" resultMap="ContractDetailMap">
        SELECT * FROM contract 
        WHERE c_buyer_id = #{buyerId} 
        AND c_house_id = #{houseId} 
        ORDER BY c_id DESC 
        LIMIT 1
    </select>

    <update id="addPayTimeEnding">
        UPDATE contract 
        SET c_paytime_ending = #{paytimeEnding} 
        WHERE c_id = #{id}
    </update>

</mapper>
