<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zgqf.house.mapper.HouseMapper">

    <!-- 根据卖家ID查询房源列表 -->
    <select id="selectBySellerId" parameterType="int" resultType="com.zgqf.house.entity.House">
        SELECT * FROM house WHERE h_seller_id = #{sellerId}
    </select>

    <!-- 插入新房源 -->
    <insert id="insert" parameterType="com.zgqf.house.entity.House" useGeneratedKeys="true" keyProperty="h_id">
        INSERT INTO house (h_seller_id, h_name, h_describe, h_address, h_detail_address,
                          h_price, h_longitude, h_latitude, h_square, h_checked)
        VALUES (#{h_seller_id}, #{h_name}, #{h_describe}, #{h_address}, #{h_detail_address},
                #{h_price}, #{h_longitude}, #{h_latitude}, #{h_square}, #{h_checked})
    </insert>

    <!-- 更新房源信息 -->
    <update id="update" parameterType="com.zgqf.house.entity.House">
        UPDATE house
        <set>
            <if test="h_name != null">h_name = #{h_name},</if>
            <if test="h_describe != null">h_describe = #{h_describe},</if>
            <if test="h_address != null">h_address = #{h_address},</if>
            <if test="h_detail_address != null">h_detail_address = #{h_detail_address},</if>
            <if test="h_price != null">h_price = #{h_price},</if>
            <if test="h_longitude != null">h_longitude = #{h_longitude},</if>
            <if test="h_latitude != null">h_latitude = #{h_latitude},</if>
            <if test="h_square != null">h_square = #{h_square},</if>
            <if test="h_checked != null">h_checked = #{h_checked},</if>
        </set>
        WHERE h_id = #{h_id}
    </update>

    <!-- 根据ID删除房源 -->
    <delete id="deleteById" parameterType="int">
        DELETE FROM house WHERE h_id = #{houseId}
    </delete>

    <!-- 查询房源列表（带分页和条件） -->
    <select id="selectHouseList" parameterType="com.zgqf.house.dto.HouseQueryDTO" resultType="com.zgqf.house.entity.House">
        SELECT h.*
        FROM house h
        <if test="sellerName != null and sellerName != ''">
            LEFT JOIN seller s ON h.h_seller_id = s.s_id
        </if>
        <if test="tag != null and tag != ''">
            LEFT JOIN house_tag ht ON h.h_id = ht.ht_house_id
            LEFT JOIN tag t ON ht.ht_tag_id = t.t_id
        </if>
        WHERE 1=1
        <if test="name != null and name != ''">
            AND h.h_name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="address != null and address != ''">
            AND h.h_address LIKE CONCAT('%', #{address}, '%')
        </if>
        <if test="minPrice != null">
            AND h.h_price &gt;= #{minPrice}
        </if>
        <if test="maxPrice != null">
            AND h.h_price &lt;= #{maxPrice}
        </if>
        <if test="minSquare != null">
            AND h.h_square &gt;= #{minSquare}
        </if>
        <if test="maxSquare != null">
            AND h.h_square &lt;= #{maxSquare}
        </if>
        <if test="checked != null">
            AND h.h_checked = #{checked}
        </if>
        <if test="sellerId != null">
            AND h.h_seller_id = #{sellerId}
        </if>
        <if test="sellerName != null and sellerName != ''">
            AND s.s_name LIKE CONCAT('%', #{sellerName}, '%')
        </if>
        <if test="tag != null and tag != ''">
            AND t.t_name = #{tag}
        </if>
        <if test="type != null and type != ''">
            AND t.t_type = #{type}
        </if>
        GROUP BY h.h_id
        ORDER BY ${sortBy} ${sortOrder}
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- 查询房源总数 -->
    <select id="countHouseList" parameterType="com.zgqf.house.dto.HouseQueryDTO" resultType="long">
        SELECT COUNT(DISTINCT h.h_id)
        FROM house h
        <if test="sellerName != null and sellerName != ''">
            LEFT JOIN seller s ON h.h_seller_id = s.s_id
        </if>
        <if test="tag != null and tag != ''">
            LEFT JOIN house_tag ht ON h.h_id = ht.ht_house_id
            LEFT JOIN tag t ON ht.ht_tag_id = t.t_id
        </if>
        WHERE 1=1
        <if test="name != null and name != ''">
            AND h.h_name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="address != null and address != ''">
            AND h.h_address LIKE CONCAT('%', #{address}, '%')
        </if>
        <if test="minPrice != null">
            AND h.h_price &gt;= #{minPrice}
        </if>
        <if test="maxPrice != null">
            AND h.h_price &lt;= #{maxPrice}
        </if>
        <if test="minSquare != null">
            AND h.h_square &gt;= #{minSquare}
        </if>
        <if test="maxSquare != null">
            AND h.h_square &lt;= #{maxSquare}
        </if>
        <if test="checked != null">
            AND h.h_checked = #{checked}
        </if>
        <if test="sellerId != null">
            AND h.h_seller_id = #{sellerId}
        </if>
        <if test="sellerName != null and sellerName != ''">
            AND s.s_name LIKE CONCAT('%', #{sellerName}, '%')
        </if>
        <if test="tag != null and tag != ''">
            AND t.t_name = #{tag}
        </if>
        <if test="type != null and type != ''">
            AND t.t_type = #{type}
        </if>
    </select>

    <!-- 根据ID查询房源详情 -->
    <select id="selectHouseById" parameterType="int" resultType="com.zgqf.house.entity.House">
        SELECT * FROM house WHERE h_id = #{id}
    </select>

    <!-- 查询标签列表 -->
    <select id="selectTagsByHouseId" parameterType="int" resultType="string">
        SELECT t.t_name
        FROM tag t
        JOIN house_tag ht ON t.t_id = ht.ht_tag_id
        WHERE ht.ht_house_id = #{houseId}
    </select>

    <!-- 查询图片列表 -->
    <select id="selectPicturesByHouseId" parameterType="int" resultType="string">
        SELECT hp_picture_path FROM house_picture WHERE hp_house_id = #{houseId}
    </select>

</mapper>
