<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zgqf.house.mapper.ContractMapper">
	<!-- 查看卖家的合同列表 -->
	<select id="getContractsBySeller" resultType="com.zgqf.house.entity.Contract">
		select c.* from contract c, house h where h.h_seller_id=#{s_id}  and h.h_id = c.c_house_id
	</select>
	<!-- 查看买家的合同列表 -->
	<select id="getContractsByBuyer" resultType="com.zgqf.house.entity.Contract">
		select c.* from contract c, buyer b where b.b_id=#{b_id}  and b.b_id = c.c_buyer_id
	</select>
	<!-- 根据合同id查找合同 -->
	<select id="getContractsById" resultType="com.zgqf.house.entity.Contract">
		select * from contract where c_id = #{c_id}
	</select>
	<!-- 查看对方的商家资料 -->
	<select id="getSellerByContract" resultType="com.zgqf.house.entity.Seller">
		select s.* from contract c, seller s , house h where c.c_id = #{c_id}
		                                                and h.h_seller_id = c.c_house_id
		                                                and	h.h_seller_id = s.s_id
	</select>
	<!-- 查看对方的买家资料 -->
	<select id="getBuyerByContract" resultType="com.zgqf.house.entity.Buyer">
		select b.* from contract c , buyer b where c_id = #{c_id} and b.b_id = c.c_buyer_id
	</select>
	<!-- 签署或拒绝合同 -->
	<update id="signContract" parameterType="com.zgqf.house.entity.Contract">
		update contract set
		<if test="c_buyer_agree != null">
			 c_buyer_agree = #{c_buyer_agree}
		</if>
		<if test="c_seller_agree != null">
			 c_seller_agree = #{c_seller_agree}
		</if>
		where c_id = #{c_id}
	</update>
	<!-- 查询房子是否可用 -->
	<select id="houseUsable" resultType="com.zgqf.house.entity.Contract">
		select * from view_house where vh_id = #{c_house_id} and vh_house_status = 0
	</select>
	<!-- 创建新合同 -->
	<insert id="insertContract" parameterType="com.zgqf.house.entity.Contract">
		insert into contract (c_id,c_house_id,c_pay_way,c_buyer_id,c_total_price)
		values (null, #{c_house_id}, #{c_pay_way},#{c_buyer_id},#{c_total_price})
	</insert>

	<!-- 查找新添加的合同 -->
	<select id="getLastInsertContract" parameterType="com.zgqf.house.entity.Contract" resultType="com.zgqf.house.entity.Contract">
		select * from contract where c_buyer_id = #{c_buyer_id}
		                         and c_pay_way = #{c_pay_way}
		                         and c_house_id = #{c_house_id}
		                       order by c_id desc
		                       limit 1
	</select>
	<update id="addPayTimeEnding" parameterType="com.zgqf.house.entity.Contract">
		update contract set c_paytime_ending = #{c_paytime_ending}
		where c_id = #{c_id}
	</update>
    <!-- === 新增方法以支持合并后的 Service 逻辑 === -->

    <!-- 通用查询条件 -->
    <sql id="Contract_Where_Clause">
        <where>
            <if test="buyerId != null">
                AND c.c_buyer_id = #{buyerId}
            </if>
            <if test="sellerId != null">
                AND h.h_seller_id = #{sellerId}
            </if>
            <if test="houseId != null">
                AND c.c_house_id = #{houseId}
            </if>
            <if test="buyerAgree != null">
                AND c.c_buyer_agree = #{buyerAgree}
            </if>
            <if test="sellerAgree != null">
                AND c.c_seller_agree = #{sellerAgree}
            </if>
            <if test="paid != null">
                AND c.c_paid = #{paid}
            </if>
            <if test="delivered != null">
                AND c.c_delivered = #{delivered}
            </if>
        </where>
    </sql>

    <!-- 条件查询合同列表 -->
    <select id="selectContractList" resultType="com.zgqf.house.entity.Contract">
        SELECT c.*, i.i_down_payment as c_down_payment, i.i_total_periods as c_total_periods, i.i_paid_count as c_paid_count, h.h_seller_id as sellerId
        FROM contract c
        LEFT JOIN house h ON c.c_house_id = h.h_id
        LEFT JOIN installment i ON c.c_id = i.i_contract_id
        <include refid="Contract_Where_Clause"/>
        ORDER BY ${sortBy} ${sortOrder}
        <if test="offset != null and pageSize != null">
            LIMIT #{pageSize} OFFSET #{offset}
        </if>
    </select>

    <!-- 统计合同数量 -->
    <select id="countContractList" resultType="long">
        SELECT count(c.c_id)
        FROM contract c
        LEFT JOIN house h ON c.c_house_id = h.h_id
        <include refid="Contract_Where_Clause"/>
    </select>

    <!-- 根据ID查询详情 -->
    <select id="selectContractDetailById" resultType="com.zgqf.house.entity.Contract">
        SELECT c.*, i.i_down_payment as c_down_payment, i.i_total_periods as c_total_periods, i.i_paid_count as c_paid_count, h.h_seller_id as sellerId
        FROM contract c
        LEFT JOIN house h ON c.c_house_id = h.h_id
        LEFT JOIN installment i ON c.c_id = i.i_contract_id
        WHERE c.c_id = #{id}
    </select>

    <!-- 更新合同 -->
    <update id="updateContract" parameterType="com.zgqf.house.entity.Contract">
        UPDATE contract
        <set>
            <if test="c_total_price != null">c_total_price = #{c_total_price},</if>
            <if test="c_pay_way != null">c_pay_way = #{c_pay_way},</if>
            <if test="c_paytime_ending != null">c_paytime_ending = #{c_paytime_ending},</if>
            <if test="c_paytime_actually != null">c_paytime_actually = #{c_paytime_actually},</if>
            <if test="c_delivery_ending != null">c_delivery_ending = #{c_delivery_ending},</if>
            <if test="c_delivery_actually != null">c_delivery_actually = #{c_delivery_actually},</if>
            <if test="c_buyer_agree != null">c_buyer_agree = #{c_buyer_agree},</if>
            <if test="c_seller_agree != null">c_seller_agree = #{c_seller_agree},</if>
            <if test="c_paid != null">c_paid = #{c_paid},</if>
            <if test="c_delivered != null">c_delivered = #{c_delivered},</if>
        </set>
        WHERE c_id = #{c_id}
    </update>

    <!-- 删除合同 -->
    <delete id="deleteContract">
        DELETE FROM contract WHERE c_id = #{id}
    </delete>

    <!-- 状态更新快捷方法 -->
    <update id="updateBuyerAgree">
        UPDATE contract SET c_buyer_agree = #{agree} WHERE c_id = #{id}
    </update>

    <update id="updateSellerAgree">
        UPDATE contract SET c_seller_agree = #{agree} WHERE c_id = #{id}
    </update>

    <update id="updatePaymentStatus">
        UPDATE contract SET c_paid = #{paid} WHERE c_id = #{id}
    </update>

    <update id="updateDeliveryStatus">
        UPDATE contract SET c_delivered = #{delivered} WHERE c_id = #{id}
    </update>

    <!-- 统计方法 -->
    <select id="countContractByBuyerId" resultType="long">
        SELECT count(*) FROM contract WHERE c_buyer_id = #{buyerId}
    </select>

    <select id="countContractBySellerId" resultType="long">
        SELECT count(c.c_id) 
        FROM contract c 
        JOIN house h ON c.c_house_id = h.h_id 
        WHERE h.h_seller_id = #{sellerId}
    </select>

</mapper>
